.. _template:

================================
Virtual Machine Definition File
================================

A template file consists of a set of attributes that defines a Virtual Machine. Using the command ``onetemplate create``, a template can be registered in OpenNebula to be later instantiated. For compatibility with previous versions, you can also create a new Virtual Machine directly from a template file, using the ``onevm create`` command.

.. warning:: There are some template attributes that can compromise the security of the system or the security of other VMs, and can be used **only** by users in the oneadmin group. These attributes can be configured in :ref:`oned.conf <oned_conf>`, the default ones are labeled with ``*`` in the following tables. See the complete list in the :ref:`Restricted Attributes <template_restricted_attributes>` section.

Syntax
======

The syntax of the template file is as follows:

-  Anything behind the pound or hash sign ``#`` is a **comment**.
-  **Strings** are delimited with double quotes ``"``, if a double quote is part of the string it needs to be escaped ``\\"``.
-  **Single Attributes** are in the form:

.. code::

    NAME=VALUE

-  **Vector Attributes** that contain several values can be defined as follows:

.. code::

    NAME=[NAME1=VALUE1,NAME2=VALUE2]

-  **Vector Attributes** must contain at least one value.
-  Attribute names are case insensitive, in fact the names are converted to uppercase internally.

XML Syntax
==========

Since OpenNebula 3.4, template files can be in XML, with the following syntax:

-  The root element must be ``TEMPLATE``
-  **Single Attributes** are in the form:

.. code::

    <NAME>VALUE</NAME>

-  **Vector Attributes** that contain several values can be defined as follows:

.. code::

    <NAME>
      <NAME1>VALUE1</NAME1>
      <NAME2>VALUE2</NAME2>
    </NAME>

A simple example:

.. code::

    <TEMPLATE>
      <NAME>test_vm</NAME>
      <CPU>2</CPU>
      <MEMORY>1024</MEMORY>
      <DISK>
        <IMAGE_ID>2</IMAGE_ID>
      </DISK>
      <DISK>
        <IMAGE>Data</IMAGE>
        <IMAGE_UNAME>oneadmin</IMAGE_UNAME>
      </DISK>
    </TEMPLATE>

Capacity Section
================

The following attributes can be defined to specified the capacity of a VM.

+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------+
| Attribute    | Description                                                                                                                                                                                                                                                                                       | Mandatory                                                                                |
+==============+===================================================================================================================================================================================================================================================================================================+==========================================================================================+
| **NAME**     | Name that the VM will get for description purposes. If **NAME** is not supplied a name generated by one will be in the form of ``one-<VID>``. **NOTE**: When defining a Template it is the name of the VM Template. The actual name of the VM will be set when the VM Template is instantiated.   | **YES** For Templates                                                                    |
|              |                                                                                                                                                                                                                                                                                                   |  **NO** For VMs - will be set to one-<vmid> if omitted                                   |
+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------+
| **MEMORY**   | Amount of RAM required for the VM, in Megabytes.                                                                                                                                                                                                                                                  | **YES**                                                                                  |
+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------+
| **CPU**      | Percentage of CPU divided by 100 required for the Virtual Machine, half a processor is written 0.5. This value is used by OpenNebula and the scheduler to guide the host overcommitment.                                                                                                          | **YES**                                                                                  |
+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------+
| **VCPU**     | Number of virtual cpus. This value is **optional**, the default hypervisor behavior is used, usually one virtual CPU.                                                                                                                                                                             | **YES** - will be set to 1 if omitted, this can be changed in the driver configuration   |
+--------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------+

Example:

.. code::

      NAME   = test-vm
      MEMORY = 128
      CPU    = 1

.. _template_os_and_boot_options_section:

OS and Boot Options Section
===========================

The OS system is defined with the ``OS`` vector attribute. The following sub-attributes are supported:

**Note** the hypervisor column states that the attribute is **O**\ ptional, **M**\ andatory, or ``-`` not supported for that hypervisor

+------------------+--------------------------------------------------------------------+----------------+----------------------+----------------------+
| OS Sub-Attribute |                            Description                             |      XEN       |         KVM          |        VMWARE        |
+==================+====================================================================+================+======================+======================+
| **ARCH**         | CPU architecture to virtualize                                     | -              | **M** (default i686) | **M** (default i686) |
+------------------+--------------------------------------------------------------------+----------------+----------------------+----------------------+
| **MACHINE**      | libvirt machine type. Check libvirt capabilities for the list of   | -              | O                    | -                    |
|                  | available machine types.                                           |                |                      |                      |
+------------------+--------------------------------------------------------------------+----------------+----------------------+----------------------+
| **KERNEL**       | path to the OS kernel to boot the image in the host                | O see (\*)     | O                    | -                    |
+------------------+--------------------------------------------------------------------+----------------+----------------------+----------------------+
| **KERNEL\_DS**   | image to be used as kernel (see !!)                                | O see (\*)     | O                    | -                    |
+------------------+--------------------------------------------------------------------+----------------+----------------------+----------------------+
| **INITRD**       | path to the initrd image in the host                               | O (for kernel) | O (for kernel)       | -                    |
+------------------+--------------------------------------------------------------------+----------------+----------------------+----------------------+
| **INITRD\_DS**   | image to be used as ramdisk (see !!)                               | O (for kernel) | O (for kernel)       | -                    |
+------------------+--------------------------------------------------------------------+----------------+----------------------+----------------------+
| **ROOT**         | device to be mounted as root                                       | O (for kernel) | O (for kernel)       | -                    |
+------------------+--------------------------------------------------------------------+----------------+----------------------+----------------------+
| **KERNEL\_CMD**  | arguments for the booting kernel                                   | O (for kernel) | O (for kernel)       | -                    |
+------------------+--------------------------------------------------------------------+----------------+----------------------+----------------------+
| **BOOTLOADER**   | path to the bootloader executable                                  | O see (\*)     | O                    | -                    |
+------------------+--------------------------------------------------------------------+----------------+----------------------+----------------------+
| **BOOT**         | comma separated list of boot devices types, by order of preference | O (only HVM)   | **M**                | -                    |
|                  | (first device in the list is the first device used for boot).      |                |                      |                      |
|                  | Possible values: ``hd``,\ ``fd``,\ ``cdrom`` ,\ ``network``        |                |                      |                      |
+------------------+--------------------------------------------------------------------+----------------+----------------------+----------------------+

(\*) If no ``kernel``/``initrd`` or ``bootloader`` are specified a Xen HVM will be created.

(!!) Use one of KERNEL\_DS or KERNEL (and INITRD or INITRD\_DS).

KERNEL\_DS and INITRD\_DS refer to and image registered in a File Datastore and must be of type KERNEL and RAMDISK, respectively. The image should be refer using one of the following:

-  ``$FILE[IMAGE=<image name>]``, to select own files
-  ``$FILE[IMAGE=<image name>, <IMAGE_UNAME|IMAGE_UID>=<owner name|owner id>]``, to select images owned by other users, by user name or uid.
-  ``$FILE[IMAGE_ID=<image id>]``, global file selection

Example, a VM booting from ``sda1`` with kernel ``/vmlinuz`` :

.. code::

    OS = [ KERNEL     = /vmlinuz,
           INITRD     = /initrd.img,
           ROOT       = sda1,
           KERNEL_CMD = "ro xencons=tty console=tty1"]

.. code::

    OS = [ KERNEL_DS  = "$FILE[IMAGE=\"kernel 3.6\"]",
           INITRD_DS  = "$FILE[IMAGE=\"initrd 3.6\"]",
           ROOT       = sda1,
           KERNEL_CMD = "ro xencons=tty console=tty1"]

Features Section
================

This section configures the features enabled for the VM.

**Note** the hypervisor column states that the attribute is **O**\ ptional or ``-`` not supported for that hypervisor

+-----------------+---------------------------------------------------------+---------+-----+
|  Sub-Attribute  |                       Description                       | XEN HVM | KVM |
+=================+=========================================================+=========+=====+
| **PAE**         | Physical address extension mode allows 32-bit           | O       | O   |
|                 | guests to address more than 4 GB of memory              |         |     |
+-----------------+---------------------------------------------------------+---------+-----+
| **ACPI**        | Useful for power management, for example, with          | O       | O   |
|                 | KVM guests it is required for graceful shutdown to work |         |     |
+-----------------+---------------------------------------------------------+---------+-----+
| **APIC**        | Enables the advanced programmable IRQ management.       | O       | O   |
|                 | Useful for SMP machines.                                |         |     |
+-----------------+---------------------------------------------------------+---------+-----+
| **LOCALTIME**   | The guest clock will be synchronized to the host's      | -       | O   |
|                 | configured timezone when booted. Useful for Windows VMs |         |     |
+-----------------+---------------------------------------------------------+---------+-----+
| **HYPERV**      | Add hyperv extensions to the VM. The options can be     | -       | O   |
|                 | configured in the driver configuration,                 |         |     |
|                 | HYPERV_OPTIONS                                          |         |     |
+-----------------+---------------------------------------------------------+---------+-----+
| **DEVICE_MODE** | Used to change the IO emulator in Xen HVM.              | O       | -   |
+-----------------+---------------------------------------------------------+---------+-----+

.. code::

    FEATURE = [
        PAE = "yes",
        ACPI = "yes",
        APIC = "no",
        DEVICE_MODE = "qemu-dm"
    ]

Disks Section
=============

The disks of a VM are defined with the ``DISK`` vector attribute. You can define as many ``DISK`` attributes as you need. There are three types of disks:

-  Persistent disks, uses an Image registered in a Datastore mark as persistent.
-  Clone disks, uses an Image registered in a Datastore. Changes to the images will be discarded. A clone disk can be saved as other image.
-  Volatile disks, created on-the-fly on the target hosts. Disks are disposed when the VM is shutdown and cannot be saved\_as

Persistent and Clone Disks
--------------------------

+----------------------------------------------------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+
|                                   Description                                    |  DISK Sub-Attribute  |                Xen                 |                KVM                 |               VMware               |
+==================================================================================+======================+====================================+====================================+====================================+
| ID of the Image to use                                                           | **IMAGE\_ID**        | **Mandatory** (no IMAGE)           | **Mandatory** (no IMAGE)           | **Mandatory** (no IMAGE)           |
+----------------------------------------------------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+
| Name of the Image to use                                                         | **IMAGE**            | **Mandatory** (no IMAGE\_ID)       | **Mandatory** (no IMAGE\_ID)       | **Mandatory** (no IMAGE\_ID)       |
+----------------------------------------------------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+
| To select the IMAGE of a given user by her ID                                    | **IMAGE\_UID**       | Optional                           | Optional                           | Optional                           |
+----------------------------------------------------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+
| To select the IMAGE of a given user by her NAME                                  | **IMAGE\_UNAME**     | Optional                           | Optional                           | Optional                           |
+----------------------------------------------------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+
| Prefix for the emulated device this image will be                                | **DEV\_PREFIX**      | Optional                           | Optional                           | Optional                           |
| mounted at. For instance, ``hd``, ``sd``, or ``vd``                              |                      |                                    |                                    |                                    |
| for KVM virtio. If omitted, the dev\_prefix attribute                            |                      |                                    |                                    |                                    |
| of the `Image <img_template>`__ will be used                                     |                      |                                    |                                    |                                    |
+----------------------------------------------------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+
| Device to map image disk. If set, it will overwrite                              | **TARGET**           | Optional                           | Optional                           | Optional                           |
| the default device mapping.                                                      |                      |                                    |                                    |                                    |
+----------------------------------------------------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+
| Specific image mapping driver                                                    | **DRIVER**           | Optional e.g.:                     | Optional e.g.:                     | -                                  |
|                                                                                  |                      | ``tap:aio:``,\ ``file:``           | ``raw``, ``qcow2``                 |                                    |
+----------------------------------------------------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+
| Selects the cache mechanism for the disk. Values                                 | **CACHE**            | -                                  | Optional                           | -                                  |
| are ``default``, ``none``, ``writethrough``,                                     |                      |                                    |                                    |                                    |
| ``writeback``, ``directsync`` and ``unsafe``. More info in the                   |                      |                                    |                                    |                                    |
| `libvirt documentation <http://libvirt.org/formatdomain.html#elementsDevices>`__ |                      |                                    |                                    |                                    |
+----------------------------------------------------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+
| Set how the image is exposed by the hypervisor                                   | **READONLY**         | Optional e.g.: ``yes``, ``no``.    | Optional e.g.: ``yes``, ``no``.    | Optional e.g.: ``yes``, ``no``.    |
|                                                                                  |                      | This attribute should only be used | This attribute should only be used | This attribute should only be used |
|                                                                                  |                      | for special storage configurations | for special storage configurations | for special storage configurations |
+----------------------------------------------------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+
| Set IO policy. Values are ``threads``, ``native``                                | **IO**               | -                                  | Optional                           | -                                  |
+----------------------------------------------------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+
| IO throttling attributes for the disk. They are specified in bytes or IOPS       | **TOTAL_BYTES_SEC**, |                                    |                                    |                                    |
| (IO Operations) and can be specified for the total (read+write) or specific for  | **READ_BYTES_SEC**,  |                                    |                                    |                                    |
| read or write. Total and read or write can not be used at the same time.         | **WRITE_BYTES_SEC**  |                                    |                                    |                                    |
| By default these parameters are only allowed to be used by oneadmin.             | **TOTAL_IOPS_SEC**,  |                                    |                                    |                                    |
|                                                                                  | **READ_IOPS_SEC**,   |                                    |                                    |                                    |
|                                                                                  | **WRITE_BYTES_SEC**  | -                                  | Optional                           | -                                  |
+----------------------------------------------------------------------------------+----------------------+------------------------------------+------------------------------------+------------------------------------+


Volatile DISKS
--------------

+----------------------+----------------------------------------------------------------------------------+---------------------------------+---------------------------------+---------------------------------+
|  DISK Sub-Attribute  |                                   Description                                    |               XEN               |               KVM               |              VMWARE             |
+======================+==================================================================================+=================================+=================================+=================================+
| **TYPE**             | Type of the disk:\ ``swap``, ``fs``                                              | Optional                        | Optional                        | Optional                        |
+----------------------+----------------------------------------------------------------------------------+---------------------------------+---------------------------------+---------------------------------+
| **SIZE**             | size in MB                                                                       | Optional                        | Optional                        | Optional                        |
+----------------------+----------------------------------------------------------------------------------+---------------------------------+---------------------------------+---------------------------------+
| **FORMAT**           | filesystem for **fs** images: ``ext2``,                                          | **Mandatory** (for fs)          | **Mandatory** (for fs)          | **Mandatory** (for fs)          |
|                      | ``ext3``\ … ``raw`` will not format the image.                                   |                                 |                                 |                                 |
+----------------------+----------------------------------------------------------------------------------+---------------------------------+---------------------------------+---------------------------------+
| **DEV\_PREFIX**      | Prefix for the emulated device this image                                        | Optional                        | Optional                        | Optional                        |
|                      | will be mounted at. For instance, ``hd``,                                        |                                 |                                 |                                 |
|                      | ``sd``. If omitted, the default dev\_prefix                                      |                                 |                                 |                                 |
|                      | set in `oned.conf <oned_conf>`__ will be used                                    |                                 |                                 |                                 |
+----------------------+----------------------------------------------------------------------------------+---------------------------------+---------------------------------+---------------------------------+
| **TARGET**           | device to map disk                                                               | Optional                        | Optional                        | Optional                        |
+----------------------+----------------------------------------------------------------------------------+---------------------------------+---------------------------------+---------------------------------+
| **DRIVER**           | special disk mapping options. KVM: ``raw``,                                      | Optional                        | Optional                        | Optional                        |
|                      | ``qcow2``. Xen: ``tap:aio:``, ``file:``                                          |                                 |                                 |                                 |
+----------------------+----------------------------------------------------------------------------------+---------------------------------+---------------------------------+---------------------------------+
| **CACHE**            | Selects the cache mechanism for the disk.                                        | -                               | Optional                        | -                               |
|                      | Values are ``default``, ``none``,                                                |                                 |                                 |                                 |
|                      | ``writethrough``, ``writeback``,                                                 |                                 |                                 |                                 |
|                      | ``directsync`` and ``unsafe``. More info                                         |                                 |                                 |                                 |
|                      | in the                                                                           |                                 |                                 |                                 |
|                      | `libvirt documentation <http://libvirt.org/formatdomain.html#elementsDevices>`__ |                                 |                                 |                                 |
+----------------------+----------------------------------------------------------------------------------+---------------------------------+---------------------------------+---------------------------------+
| **READONLY**         | Set how the image is exposed by the hypervisor                                   | Optional e.g.: ``yes``, ``no``. | Optional e.g.: ``yes``, ``no``. | Optional e.g.: ``yes``, ``no``. |
|                      |                                                                                  | This attribute should only be   | This attribute should only be   | This attribute should only be   |
|                      |                                                                                  | used for special storage        | used for special storage        | used for special storage        |
|                      |                                                                                  | configurations                  | configurations                  | configurations                  |
+----------------------+----------------------------------------------------------------------------------+---------------------------------+---------------------------------+---------------------------------+
| **IO**               | Set IO policy. Values are ``threads``, ``native``                                | -                               | Optional                        | -                               |
+----------------------+----------------------------------------------------------------------------------+---------------------------------+---------------------------------+---------------------------------+
| **TOTAL_BYTES_SEC**, | IO throttling attributes for the disk. They are specified in bytes or IOPS       | -                               | Optional                        | -                               |
| **READ_BYTES_SEC**,  | (IO Operations) and can be specified for the total (read+write) or specific for  |                                 |                                 |                                 |
| **WRITE_BYTES_SEC**, | read or write. Total and read or write can not be used at the same time.         |                                 |                                 |                                 |
| **TOTAL_IOPS_SEC**,  | By default these parameters are only allowed to be used by oneadmin.             |                                 |                                 |                                 |
| **READ_IOPS_SEC**,   |                                                                                  |                                 |                                 |                                 |
| **WRITE_BYTES_SEC**  |                                                                                  |                                 |                                 |                                 |
+----------------------+----------------------------------------------------------------------------------+---------------------------------+---------------------------------+---------------------------------+


.. _template_disks_device_mapping:

Disks Device Mapping
--------------------

If the TARGET attribute is not set for a disk, OpenNebula will automatically assign it using the following precedence, starting with ``dev_prefix + a``:

-  First **OS** type Image.
-  Contextualization CDROM.
-  **CDROM** type Images.
-  The rest of **DATABLOCK** and **OS** Images, and **Volatile** disks.

Please visit the guide for :ref:`managing images <img_guide>` and the :ref:`image template reference <img_template>` to learn more about the different image types.

You can find a complete description of the contextualization features in the :ref:`contextualization guide <cong>`.

The default device prefix ``sd`` can be changed to ``hd`` or other prefix that suits your virtualization hypervisor requirements. You can find more information in the :ref:`daemon configuration guide <oned_conf>`.

An Example
----------

This a sample section for disks. There are four disks using the image repository, and two volatile ones. Note that ``fs`` and ``swap`` are generated on-the-fly:

.. code::

    # First OS image, will be mapped to sda. Use image with ID 2
    DISK = [ IMAGE_ID  = 2 ]
     
    # First DATABLOCK image, mapped to sdb.
    # Use the Image named Data, owned by the user named oneadmin.
    DISK = [ IMAGE        = "Data",
             IMAGE_UNAME  = "oneadmin" ]
     
    # Second DATABLOCK image, mapped to sdc
    # Use the Image named Results owned by user with ID 7.
    DISK = [ IMAGE        = "Results",
             IMAGE_UID    = 7 ]
     
    # Third DATABLOCK image, mapped to sdd
    # Use the Image named Experiments owned by user instantiating the VM.
    DISK = [ IMAGE        = "Experiments" ]
     
    # Volatile filesystem disk, sde
    DISK = [ TYPE   = fs,
             SIZE   = 4096,
             FORMAT = ext3 ]
     
    # swap, sdf
    DISK = [ TYPE     = swap,
             SIZE     = 1024 ]

Because this VM did not declare a CONTEXT or any disk using a CDROM Image, the first DATABLOCK found is placed right after the OS Image, in ``sdb``. For more information on image management and moving please check the :ref:`Storage guide <sm>`.

.. _template_network_section:

Network Section
===============

+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| NIC Sub-Attribute       | Description                                                                                                                                                                              | Mandatory                        |
+=========================+==========================================================================================================================================================================================+==================================+
| **NETWORK\_ID**         | ID of the network to attach this device, as defined by ``onevnet``. Use if no NETWORK                                                                                                    | **Mandatory** (No NETWORK)       |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **NETWORK**             | Name of the network to use (of those owned by user). Use if no NETWORK\_ID                                                                                                               | **Mandatory** (No NETWORK\_ID)   |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **NETWORK\_UID**        | To select the NETWORK of a given user by her ID                                                                                                                                          | Optional                         |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **NETWORK\_UNAME**      | To select the NETWORK of a given user by her NAME                                                                                                                                        | Optional                         |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **IP**                  | Request an specific IP from the ``NETWORK``                                                                                                                                              | Optional                         |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **MAC\***               | Request an specific HW address from the network interface                                                                                                                                | Optional                         |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **BRIDGE**              | Name of the bridge the network device is going to be attached to.                                                                                                                        | Optional                         |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **TARGET**              | name for the tun device created for the VM                                                                                                                                               | Option for KVM and VMWare        |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **SCRIPT**              | name of a shell script to be executed after creating the tun device for the VM                                                                                                           | Optional                         |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **MODEL**               | hardware that will emulate this network interface. With Xen this is the type attribute of the vif. In KVM you can choose ``virtio`` to select its specific virtualization IO framework   | Optional                         |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **WHITE\_PORTS\_TCP**   | **``iptables_range``**: Permits access to the VM only through the specified ports in the TCP protocol. Supersedes BLACK\_PORTS\_TCP if defined.                                          | Optional                         |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **BLACK\_PORTS\_TCP**   | **``iptables_range``**: Doesn't permit access to the VM through the specified ports in the TCP protocol. Superseded by WHITE\_PORTS\_TCP if defined.                                     | Optional                         |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **WHITE\_PORTS\_UDP**   | **``iptables_range``**: Permits access to the VM only through the specified ports in the UDP protocol. Supersedes BLACK\_PORTS\_UDP if defined.                                          | Optional                         |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **BLACK\_PORTS\_UDP**   | **``iptables_range``**: Doesn't permit access to the VM through the specified ports in the UDP protocol. Superseded by WHITE\_PORTS\_UDP if defined.                                     | Optional                         |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+
| **ICMP**                | **drop**: Blocks ICMP connections to the VM. By default it's set to accept.                                                                                                              | Optional                         |
+-------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------+


.. warning:: The PORTS and ICMP attributes require the firewalling functionality to be configured. Please read the :ref:`firewall configuration guide <firewall>`.

Example, a VM with two NIC attached to two different networks:

.. code::

    NIC = [ NETWORK_ID = 1 ]
     
    NIC = [ NETWORK     = "Blue",
            NETWORK_UID = 0 ]

For more information on setting up virtual networks please check the :ref:`Managing Virtual Networks guide <vgg>`.

Network Defaults
--------------------------------------------------------------------------------

You can define a ``NIC_DEFAULT`` attribute with values that will be copied to each new ``NIC``. This is specially useful for an administrator to define configuration parameters, such as ``MODEL``, that final users may not be aware of.

.. code::

    NIC_DEFAULT = [ MODEL = "virtio" ]


I/O Devices Section
===================

The following I/O interfaces can be defined for a VM:

**Note** the hypervisor column states that the attribute is **O**\ ptional, **M**\ andatory, or ``-`` not supported for that hypervisor

+--------------+--------------------------------------------------------------------------------------+-------------+-----+--------+
|  Attribute   |                                     Description                                      |     XEN     | KVM | VMWARE |
+==============+======================================================================================+=============+=====+========+
| **INPUT**    | Define input devices, available sub-attributes:                                      | O (only usb | O   | -      |
|              |                                                                                      | tablet is   |     |        |
|              | * **TYPE**: values are ``mouse`` or ``tablet``                                       | supported)  |     |        |
|              | * **BUS**: values are ``usb``, ``ps2`` or ``xen``                                    |             |     |        |
+--------------+--------------------------------------------------------------------------------------+-------------+-----+--------+
| **GRAPHICS** | Wether the VM should export its graphical display and how, available sub-attributes: | O           | O   | -      |
|              |                                                                                      |             |     |        |
|              | * **TYPE**: values: ``vnc``, ``sdl``, ``spice``                                      |             |     |        |
|              | * **LISTEN**: IP to listen on.                                                       |             |     |        |
|              | * **PORT**: port for the VNC server                                                  |             |     |        |
|              | * **PASSWD**: password for the VNC server                                            |             |     |        |
|              | * **KEYMAP**: keyboard configuration locale to use in the VNC display                |             |     |        |
+--------------+--------------------------------------------------------------------------------------+-------------+-----+--------+

Example:

.. code::

    GRAPHICS = [
      TYPE    = "vnc",
      LISTEN  = "0.0.0.0",
      PORT    = "5"]

.. warning:: For KVM hypervisor the port number is a real one, not the VNC port. So for VNC port 0 you should specify 5900, for port 1 is 5901 and so on.

.. warning:: If the user does not specify the port variable, OpenNebula will automatically assign ``$VNC_BASE_PORT + $VMID``, allowing to generate different ports for VMs so they do not collide. The ``VNC_BASE_PORT`` is specified inside the ``oned.conf`` file.

.. _template_context:

Context Section
===============

Context information is passed to the Virtual Machine via an ISO mounted as a partition. This information can be defined in the VM template in the optional section called Context, with the following attributes:

+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
|    Attribute    |                                                                                                                                                      Description                                                                                                                                                       | Mandatory |
+=================+========================================================================================================================================================================================================================================================================================================================+===========+
| **VARIABLE**    | Variables that store values related to this virtual machine or others. The name of the variable is arbitrary (in the example, we use hostname).                                                                                                                                                                        | Optional  |
+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| **FILES \***    | space-separated list of paths to include in context device.                                                                                                                                                                                                                                                            | Optional  |
+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| **FILES\_DS**   | space-separated list of File images to include in context device.                                                                                                                                                                                                                                                      | Optional  |
+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| **TARGET**      | device to attach the context ISO.                                                                                                                                                                                                                                                                                      | Optional  |
+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| **TOKEN**       | ``YES`` to create a token.txt file for :ref:`OneGate monitorization <onegate_usage>`                                                                                                                                                                                                                                   | Optional  |
+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+
| **NETWORK**     | ``YES`` to fill automatically the networking parameters for each NIC, used by the :ref:`Contextualization packages <context_overview>`                                                                                                                                                                                 | Optional  |
+-----------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------+

\* only for users in oneadmin group

The values referred to by **VARIABLE** can be defined :

**Hardcoded values:**

.. code::

       HOSTNAME   = "MAINHOST"

**Using template variables**

``$<template_variable>``: any single value variable of the VM template, like for example:

.. code::

          IP_GEN     = "10.0.0.$VMID"

``$<template_variable>[<attribute>]``: Any single value contained in a multiple value variable in the VM template, like for example:

.. code::

          IP_PRIVATE = $NIC[IP]

``$<template_variable>[<attribute>, <attribute2>=<value2>]``: Any single value contained in the variable of the VM template, setting one attribute to discern between multiple variables called the same way, like for example:

.. code::

          IP_PUBLIC = "$NIC[IP, NETWORK=\"Public\"]"

**Using Virtual Network template variables**

``$NETWORK[<vnet_attribute>, <NETWORK_ID|NETWORK>=<vnet_id|vnet_name>]``: Any single value variable in the Virtual Network template, like for example:

.. code::

          dns = "$NETWORK[DNS, NETWORK_ID=3]"

.. note:: The network MUST be in used by any of the NICs defined in the template. The vnet\_attribute can be ``TEMPLATE`` to include the whole vnet template in XML (base64 encoded).

**Using Image template variables**

``$IMAGE[<image_attribute>, <IMAGE_ID|IMAGE>=<img_id|img_name>]``: Any single value variable in the Image template, like for example:

.. code::

          root = "$IMAGE[ROOT_PASS, IMAGE_ID=0]"

.. note:: The image MUST be in used by any of the DISKs defined in the template. The image\_attribute can be ``TEMPLATE`` to include the whole image template in XML (base64 encoded).

**Using User template variables**

``$USER[<user_attribute>]``: Any single value variable in the user (owner of the VM) template, like for example:

.. code::

          ssh_key = "$USER[SSH_KEY]"

.. note:: The user\_attribute can be ``TEMPLATE`` to include the whole user template in XML (base64 encoded).

**Pre-defined variables**, apart from those defined in the template you can use:

- ``$UID``, the uid of the VM owner
- ``$UNAME``, the name of the VM owner
- ``$GID``, the id of the VM owner's group
- ``$GNAME``, the name of the VM owner's group
- ``$TEMPLATE``, the whole template in XML format and encoded in base64

**FILES\_DS**, each file must be registered in a FILE\_DS datastore and has to be of type CONTEXT. Use the following to select files from Files Datastores:

- ``$FILE[IMAGE=<image name>]``, to select own files
- ``$FILE[IMAGE=<image name>, <IMAGE_UNAME|IMAGE_UID>=<owner name|owner id>]``, to select images owned by other users, by user name or uid.
- ``$FILE[IMAGE_ID=<image id>]``, global file selection

Example:

.. code::

    CONTEXT = [
      HOSTNAME   = "MAINHOST",
      IP_PRIVATE = "$NIC[IP]",
      DNS        = "$NETWORK[DNS, NAME=\"Public\"]",
      IP_GEN     = "10.0.0.$VMID",
      FILES      = "/service/init.sh /service/certificates /service/service.conf",
      FILES_DS   = "$FILE[IMAGE_ID=34] $FILE[IMAGE=\"kernel\"]",
      TARGET     = "sdc"
    ]

.. _template_placement_section:

Placement Section
=================

The following attributes placement constraints and preferences for the VM:

+-------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+
| Attribute                     | Description                                                                                                                                               |
+===============================+===========================================================================================================================================================+
| **SCHED\_REQUIREMENTS**       | Boolean expression that rules out provisioning hosts from list of machines suitable to run this VM.                                                       |
+-------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+
| **SCHED\_RANK**               | This field sets which attribute will be used to sort the suitable hosts for this VM. Basically, it defines which hosts are *more suitable* than others.   |
+-------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+
| **SCHED\_DS\_REQUIREMENTS**   | Boolean expression that rules out entries from the pool of datastores suitable to run this VM.                                                            |
+-------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+
| **SCHED\_DS\_RANK**           | States which attribute will be used to sort the suitable datastores for this VM. Basically, it defines which datastores are more suitable than others.    |
+-------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------+

Example:

.. code::

    SCHED_REQUIREMENTS    = "CPUSPEED > 1000"
    SCHED_RANK            = "FREE_CPU"
    SCHED_DS_REQUIREMENTS = "NAME=GoldenCephDS"
    SCHED_DS_RANK         = FREE_MB

.. _template_requirement_expression_syntax:

Requirement Expression Syntax
-----------------------------

The syntax of the requirement expressions is defined as:

.. code::

      stmt::= expr';'
      expr::= VARIABLE '=' NUMBER
            | VARIABLE '!=' NUMBER
            | VARIABLE '>' NUMBER
            | VARIABLE '<' NUMBER
            | VARIABLE '=' STRING
            | VARIABLE '!=' STRING
            | expr '&' expr
            | expr '|' expr
            | '!' expr
            | '(' expr ')'

Each expression is evaluated to 1 (TRUE) or 0 (FALSE). Only those hosts for which the requirement expression is evaluated to TRUE will be considered to run the VM.

Logical operators work as expected ( less '<', greater '>', '&' AND, '\|' OR, '!' NOT), '=' means equals with numbers (floats and integers). When you use '=' operator with strings, it performs a shell wildcard pattern matching.

Any variable included in the Host template or its Cluster template can be used in the requirements. You may also use an XPath expression to refer to the attribute.

There is a special variable, ``CURRENT_VMS``, that can be used to deploy VMs in a Host where other VMs are (not) running. It can be used only with the operators '=' and '!='

.. warning:: Check the :ref:`Monitoring Subsystem <devel-im>` guide to find out how to extend the information model and add any information probe to the Hosts.

.. warning:: There are some predefined variables that can be used: ``NAME``, ``MAX_CPU``, ``MAX_MEM``, ``FREE_MEM``, ``FREE_CPU``, ``USED_MEM``, ``USED_CPU``, ``HYPERVISOR``

Examples:

.. code::

    # Only aquila hosts (aquila0, aquila1...), note the quotes
    SCHED_REQUIREMENTS = "NAME = \"aquila*\""
     
    # Only those resources with more than 60% of free CPU
    SCHED_REQUIREMENTS = "FREE_CPU > 60"
     
    # Deploy only in the Host where VM 5 is running
    SCHED_REQUIREMENTS = "CURRENT_VMS = 5"
     
    # Deploy in any Host, except the ones where VM 5 or VM 7 are running
    SCHED_REQUIREMENTS = "(CURRENT_VMS != 5) & (CURRENT_VMS != 7)"

.. warning:: If using OpenNebula's default match-making scheduler in a hypervisor heterogeneous environment, it is a good idea to add an extra line like the following to the VM template to ensure its placement in a VMWare hypervisor enabled machine.

.. code::

    SCHED_REQUIREMENTS = "HYPERVISOR=\"vmware\""

.. warning:: Template variables can be used in the SCHED\_REQUIREMENTS section.

-  ``$<template_variable>``: any single value variable of the VM template.
-  ``$<template_variable>[<attribute>]``: Any single value contained in a multiple value variable in the VM template.
-  ``$<template_variable>[<attribute>, <attribute2>=<value2>]``: Any single value contained in a multiple value variable in the VM template, setting one atribute to discern between multiple variables called the same way.

For example, if you have a custom probe that generates a MACS attribute for the hosts, you can do short of a MAC pinning, so only VMs with a given MAC runs in a given host.

.. code::

    SCHED_REQUIREMENTS = "MAC=\"$NIC[MAC]\""

Rank Expression Syntax
----------------------

The syntax of the rank expressions is defined as:

.. code::

      stmt::= expr';'
      expr::= VARIABLE
            | NUMBER
            | expr '+' expr
            | expr '-' expr
            | expr '*' expr
            | expr '/' expr
            | '-' expr
            | '(' expr ')'

Rank expressions are evaluated using each host information. '+', '-', '\*', '/' and '-' are arithmetic operators. The rank expression is calculated using floating point arithmetics, and then round to an integer value.

.. warning:: The rank expression is evaluated for each host, those hosts with a higher rank are used first to start the VM. The rank policy must be implemented by the scheduler. Check the configuration guide to configure the scheduler.

.. warning:: Similar to the requirements attribute, any number (integer or float) attribute defined for the host can be used in the rank attribute

Examples:

.. code::

    # First those resources with a higher Free CPU
      SCHED_RANK = "FREE_CPU"
     
    # Consider also the CPU temperature
      SCHED_RANK = "FREE_CPU * 100 - TEMPERATURE"

.. _template_raw_section:

RAW Section
===========

This optional section of the VM template is used whenever the need to pass special attributes to the underlying hypervisor arises. Anything placed in the data attribute gets passed straight to the hypervisor, unmodified.

+---------------------+-----------------------------------------------------+-------+-------+----------+
| RAW Sub-Attribute   | Description                                         | XEN   | KVM   | VMWARE   |
+=====================+=====================================================+=======+=======+==========+
| **TYPE**            | Possible values are: ``kvm``, ``xen``, ``vmware``   | O     | O     | O        |
+---------------------+-----------------------------------------------------+-------+-------+----------+
| **DATA**            | Raw data to be passed directly to the hypervisor    | O     | O     | O        |
+---------------------+-----------------------------------------------------+-------+-------+----------+
| **DATA\_VMX**       | Raw data to be added directly to the .vmx file      | -     | -     | O        |
+---------------------+-----------------------------------------------------+-------+-------+----------+

Example:

Add a custom builder and bootloader to a Xen VM:

.. code::

    RAW     = [
          TYPE  = "xen",
          DATA  = "builder=\"linux\"
                   bootloader=\"/usr/lib/xen/boot/domUloader.py\"
                   bootargs=\"--entry=xvda2:/boot/vmlinuz-xenpae,/boot/vmlinuz-xenpae\"" ]

Add a guest type and a specific scsi controller to a vmware VM:

.. code::

    RAW = [
      TYPE     = "vmware",
      DATA     = "<devices><controller type='scsi' index='0' model='lsilogic'/></devices>",
      DATA_VMX = "pciBridge0.present = \"TRUE\"\nguestOS=\"windows7srv-64\""
    ]

.. _template_restricted_attributes:

Restricted Attributes
=====================

All the **default** restricted attributes to users in the oneadmin group are summarized in the following list:

-  CONTEXT/FILES
-  DISK/SOURCE
-  NIC/MAC
-  NIC/VLAN\_ID
-  SCHED\_RANK

These attributes can be configured in :ref:`oned.conf <oned_conf>`.

.. _template_user_inputs:

User Inputs
===========

``USER_INPUTS`` provides the template creator with the possibility to dynamically ask the user instantiating the template for dynamic values that must be defined.

.. code::

    USER_INPUTS = [
      BLOG_TITLE="M|text|Blog Title",
      MYSQL_PASSWORD="M|password|MySQL Password",
      <VAR>="M|<type>|<desc>"
    ]

    CONTEXT=[
      BLOG_TITLE="$BLOG_TITLE",
      MYSQL_PASSWORD="$MYSQL_PASSWORD" ]

Note that the CONTEXT references the variables defined in the USER_INPUTS so the value is injected into the VM.

Valid ``types`` are ``text`` and ``password``.
